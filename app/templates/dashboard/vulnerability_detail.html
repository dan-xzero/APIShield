{% extends "dashboard/base.html" %}

{% block title %}{{ vulnerability.name }} - Vulnerability Details{% endblock %}

{% block content %}
<style>
.evidence-section {
            background: #f8f9fa;
    border-radius: 8px;
            padding: 15px;
    margin-bottom: 15px;
}

.evidence-section h6 {
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.request-section {
    border-left: 4px solid #007bff;
    background: #f0f8ff;
}

.response-section {
    border-left: 4px solid #28a745;
    background: #f0fff0;
}

.vulnerability-info-section {
    border-left: 4px solid #ffc107;
    background: #fffbf0;
}

.evidence-highlight {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
}

.evidence-highlight strong {
    color: #856404;
}

.code-block {
            background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
        
.status-badge {
            font-size: 0.8em;
    padding: 4px 8px;
}

.tool-badge {
    background: linear-gradient(45deg, #17a2b8, #20c997);
    color: white;
            font-weight: bold;
        }
    </style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">{{ vulnerability.name }}</h1>
                    <p class="text-muted mb-0">{{ vulnerability.description[:200] }}{% if vulnerability.description|length > 200 %}...{% endif %}</p>
                </div>
                <a href="{{ url_for('dashboard.vulnerabilities') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Vulnerabilities
                </a>
            </div>
        </div>
    </div>
    
        <!-- Vulnerability Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Vulnerability Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Name:</strong>
                                <span>{{ vulnerability.name }}</span>
                            </div>
                            <div class="mb-3">
                                <strong>Severity:</strong>
                                <span class="badge bg-{{ 'danger' if vulnerability.severity == 'high' else 'warning' if vulnerability.severity == 'medium' else 'info' if vulnerability.severity == 'low' else 'secondary' }}">
                                    {{ vulnerability.severity.upper() }}
                                </span>
                            </div>
                            <div class="mb-3">
                                <strong>Category:</strong>
                                <span class="badge bg-secondary">{{ vulnerability.category or 'Unknown' }}</span>
                            </div>
                            <div class="mb-3">
                                <strong>CVSS Score:</strong>
                                {% if vulnerability.cvss_score %}
                                    <span class="badge bg-{{ 'danger' if vulnerability.cvss_score >= 7 else 'warning' if vulnerability.cvss_score >= 4 else 'info' }}">
                                        {{ vulnerability.cvss_score }}/10
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Risk Score:</strong>
                                {% if vulnerability.risk_score %}
                                    <span class="badge bg-{{ 'danger' if vulnerability.risk_score >= 7 else 'warning' if vulnerability.risk_score >= 4 else 'success' }}">
                                        {{ vulnerability.risk_score }}/10
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong>Status:</strong>
                                {% if vulnerability.false_positive %}
                                    <span class="badge bg-warning">False Positive</span>
                                {% elif vulnerability.remediated %}
                                    <span class="badge bg-success">Remediated</span>
                        {% else %}
                                    <span class="badge bg-danger">Open</span>
                        {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong>Found:</strong>
                                <span>{{ vulnerability.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                            </div>
                            <div class="mb-3">
                                <strong>Updated:</strong>
                                <span>{{ vulnerability.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>
            
    <!-- Related Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-link"></i> Related Endpoint
                    </h5>
                </div>
                <div class="card-body">
                    {% if vulnerability.scan and vulnerability.scan.endpoint %}
                        <div class="mb-3">
                            <strong>Endpoint:</strong>
                            <code>{{ vulnerability.scan.endpoint.path }}</code>
                        </div>
                        <div class="mb-3">
                            <strong>Method:</strong>
                            <span class="badge bg-{{ 'success' if vulnerability.scan.endpoint.method == 'GET' else 'primary' if vulnerability.scan.endpoint.method == 'POST' else 'warning' if vulnerability.scan.endpoint.method == 'PUT' else 'danger' if vulnerability.scan.endpoint.method == 'DELETE' else 'info' }}">
                                {{ vulnerability.scan.endpoint.method }}
                            </span>
                        </div>
                        <div class="mb-3">
                            <strong>Service:</strong>
                            {% if vulnerability.scan.endpoint.service %}
                                <a href="{{ url_for('dashboard.service_detail', service_id=vulnerability.scan.endpoint.service_id) }}">
                                    {{ vulnerability.scan.endpoint.service.name }}
                                </a>
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('dashboard.endpoint_detail', endpoint_id=vulnerability.scan.endpoint.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View Endpoint
                        </a>
                    {% else %}
                        <p class="text-muted">No endpoint information available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search"></i> Scan Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if vulnerability.scan %}
                        <div class="mb-3">
                            <strong>Scan ID:</strong>
                            <code>{{ vulnerability.scan.id }}</code>
                        </div>
                        <div class="mb-3">
                            <strong>Scan Type:</strong>
                            <span class="badge bg-info">{{ vulnerability.scan.scan_type or 'combined' }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Scan Time:</strong>
                            <span>{{ vulnerability.scan.scan_time.strftime('%Y-%m-%d %H:%M:%S') if vulnerability.scan.scan_time else 'N/A' }}</span>
                </div>
                        <div class="mb-3">
                            <strong>Status:</strong>
                            <span class="badge bg-{{ 'success' if vulnerability.scan.status == 'completed' else 'warning' if vulnerability.scan.status == 'running' else 'danger' if vulnerability.scan.status == 'failed' else 'secondary' }}">
                                {{ vulnerability.scan.status.upper() }}
                            </span>
                </div>
                        <a href="{{ url_for('dashboard.scan_detail', scan_id=vulnerability.scan.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View Scan
                        </a>
                    {% else %}
                        <p class="text-muted">No scan information available.</p>
                {% endif %}
                </div>
                </div>
            </div>
        </div>
        
    <!-- Description -->
    {% if vulnerability.description %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt"></i> Description
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ vulnerability.description }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Details -->
    {% if vulnerability.details %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list"></i> Technical Details
                    </h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded"><code>{{ vulnerability.details }}</code></pre>
                </div>
            </div>
        </div>
        </div>
        {% endif %}
        
        <!-- Evidence -->
        {% if vulnerability.evidence or vulnerability.details %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search"></i> Evidence & Details
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tool Information -->
                    {% if vulnerability.tool_used %}
                    <div class="mb-3">
                        <strong>Tool Used:</strong>
                        <span class="badge tool-badge">{{ vulnerability.tool_used.upper() }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Raw Evidence -->
        {% if vulnerability.evidence %}
                    <div class="mb-4 evidence-section">
                        <h6><i class="fas fa-file-alt"></i> Raw Evidence</h6>
                        <div class="code-block">{{ vulnerability.evidence }}</div>
                    </div>
                    {% endif %}
                    
                    <!-- Detailed Evidence -->
                    {% if vulnerability.details %}
                    <div class="mb-4 evidence-section">
                        <h6><i class="fas fa-bug"></i> Detailed Evidence</h6>
                        
                        <!-- AI Validation -->
                        {% if vulnerability.ai_confidence %}
                        <div class="mb-3 vulnerability-info-section">
                            <h6 class="text-warning"><i class="fas fa-robot"></i> AI Validation</h6>
                            <div class="p-3">
                                <div class="mb-2">
                                    <strong>Confidence:</strong>
                                    <span class="badge bg-{{ 'success' if vulnerability.ai_confidence == 'High' else 'warning' if vulnerability.ai_confidence == 'Medium' else 'info' }} status-badge">
                                        {{ vulnerability.ai_confidence }}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <strong>Analysis:</strong>
                                    <p>{{ vulnerability.ai_analysis }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Vulnerability Metadata -->
                        {% if vulnerability.details %}
                        <div class="mb-3 vulnerability-info-section">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Vulnerability Metadata</h6>
                            <div class="p-3">
                                {% if vulnerability.details.url %}
                                <div class="mb-2">
                                    <strong>Target URL:</strong>
                                    <code class="text-primary">{{ vulnerability.details.url }}</code>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.parameter %}
                                <div class="mb-2">
                                    <strong>Parameter:</strong>
                                    <span class="badge bg-info status-badge">{{ vulnerability.details.parameter or 'N/A' }}</span>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.attack %}
                                <div class="mb-2">
                                    <strong>Attack Vector:</strong>
                                    <span class="badge bg-warning status-badge">{{ vulnerability.details.attack or 'N/A' }}</span>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.confidence %}
                                <div class="mb-2">
                                    <strong>Confidence:</strong>
                                    <span class="badge bg-{{ 'success' if vulnerability.details.confidence == 'High' else 'warning' if vulnerability.details.confidence == 'Medium' else 'info' }} status-badge">
                                        {{ vulnerability.details.confidence }}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.cweid %}
                                <div class="mb-2">
                                    <strong>CWE ID:</strong>
                                    <a href="https://cwe.mitre.org/data/definitions/{{ vulnerability.details.cweid }}.html" target="_blank" class="badge bg-secondary status-badge">
                                        CWE-{{ vulnerability.details.cweid }}
                                    </a>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.wascid %}
                                <div class="mb-2">
                                    <strong>WASC ID:</strong>
                                    <span class="badge bg-secondary status-badge">WASC-{{ vulnerability.details.wascid }}</span>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.risk %}
                                <div class="mb-2">
                                    <strong>Risk Level:</strong>
                                    <span class="badge bg-{{ 'danger' if vulnerability.details.risk == 'High' else 'warning' if vulnerability.details.risk == 'Medium' else 'info' }} status-badge">
                                        {{ vulnerability.details.risk }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Request Details -->
                        {% if vulnerability.details.request %}
                        <div class="mb-3 request-section">
                            <h6 class="text-primary"><i class="fas fa-arrow-up"></i> Request</h6>
                            <div class="p-3">
                                {% if vulnerability.details.request.method %}
                                <div class="mb-2">
                                    <strong>Method:</strong>
                                    <span class="badge bg-primary status-badge">{{ vulnerability.details.request.method }}</span>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.request.url %}
                                <div class="mb-2">
                                    <strong>URL:</strong>
                                    <code class="text-primary">{{ vulnerability.details.request.url }}</code>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.request.headers %}
                                <div class="mb-2">
                                    <strong>Headers:</strong>
                                    <div class="code-block">{{ vulnerability.details.request.headers | tojson(indent=2) }}</div>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.request.body %}
                                <div class="mb-2">
                                    <strong>Body:</strong>
                                    <div class="code-block">{{ vulnerability.details.request.body | tojson(indent=2) }}</div>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.request.parameters %}
                                <div class="mb-2">
                                    <strong>Parameters:</strong>
                                    <div class="code-block">{{ vulnerability.details.request.parameters | tojson(indent=2) }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Response Details -->
                        {% if vulnerability.details.response %}
                        <div class="mb-3 response-section">
                            <h6 class="text-success"><i class="fas fa-arrow-down"></i> Response</h6>
                            <div class="p-3">
                                {% if vulnerability.details.response.status_code %}
                                <div class="mb-2">
                                    <strong>Status Code:</strong>
                                    <span class="badge bg-{{ 'success' if vulnerability.details.response.status_code < 400 else 'warning' if vulnerability.details.response.status_code < 500 else 'danger' }} status-badge">
                                        {{ vulnerability.details.response.status_code }}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if vulnerability.details.response.headers %}
                                <div class="mb-2">
                                    <strong>Response Headers:</strong>
                                    <div class="code-block">{{ vulnerability.details.response.headers | tojson(indent=2) }}</div>
        </div>
        {% endif %}
        
                                {% if vulnerability.details.response.body %}
                                <div class="mb-2">
                                    <strong>Response Body:</strong>
                                    <div class="code-block">{{ vulnerability.details.response.body | tojson(indent=2) }}</div>
                                </div>
                {% endif %}
            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Vulnerability Specific Details -->
                        {% if vulnerability.details.vulnerability_info %}
                        <div class="mb-3 vulnerability-info-section">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Vulnerability Information</h6>
                            <div class="p-3">
                                <div class="code-block">{{ vulnerability.details.vulnerability_info | tojson(indent=2) }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Raw Details (fallback) -->
                        {% if not vulnerability.details.request and not vulnerability.details.response and not vulnerability.details.vulnerability_info %}
                        <div class="mb-3">
                            <h6><i class="fas fa-code"></i> Raw Details</h6>
                            <div class="code-block">{{ vulnerability.details | tojson(indent=2) }}</div>
                        </div>
                        {% endif %}
            </div>
                    {% endif %}
                    
                    <!-- Evidence Highlighting -->
                    {% if vulnerability.evidence or vulnerability.details %}
                    <div class="mb-3 evidence-highlight">
                        <h6><i class="fas fa-highlighter"></i> Evidence Analysis</h6>
                        <div class="mb-0">
                            <strong>What to look for:</strong>
                            <ul class="mb-0 mt-2">
                                <!-- CWE-based guidance -->
                                {% if vulnerability.details and vulnerability.details.cweid %}
                                    {% if vulnerability.details.cweid == '693' %}
                                    <li><strong>CWE-693: Protection Mechanism Failure:</strong> Check if security controls are properly implemented and configured</li>
                                    {% elif vulnerability.details.cweid == '79' %}
                                    <li><strong>CWE-79: XSS:</strong> Look for user input reflected in responses without proper encoding</li>
                                    {% elif vulnerability.details.cweid == '89' %}
                                    <li><strong>CWE-89: SQL Injection:</strong> Check for database error messages or unexpected responses</li>
                                    {% elif vulnerability.details.cweid == '918' %}
                                    <li><strong>CWE-918: SSRF:</strong> Look for unexpected network requests or URL processing</li>
                                    {% elif vulnerability.details.cweid == '200' %}
                                    <li><strong>CWE-200: Information Exposure:</strong> Check for sensitive data in responses, headers, or error messages</li>
            {% else %}
                                    <li><strong>CWE-{{ vulnerability.details.cweid }}:</strong> Review the vulnerability details above for specific guidance</li>
                                    {% endif %}
                                {% endif %}
                                
                                <!-- Evidence-based guidance -->
                                {% if vulnerability.evidence %}
                                    {% if 'header' in vulnerability.evidence.lower() %}
                                    <li><strong>Header Injection:</strong> Check for unexpected or malicious headers in the response</li>
                                    {% endif %}
                                    {% if 'sql' in vulnerability.evidence.lower() or 'injection' in vulnerability.evidence.lower() %}
                                    <li><strong>SQL Injection:</strong> Look for database error messages or unexpected responses</li>
                                    {% endif %}
                                    {% if 'xss' in vulnerability.evidence.lower() or 'script' in vulnerability.evidence.lower() %}
                                    <li><strong>XSS:</strong> Check if user input is reflected in the response without proper encoding</li>
                                    {% endif %}
                                    {% if 'ssrf' in vulnerability.evidence.lower() or 'url' in vulnerability.evidence.lower() %}
                                    <li><strong>SSRF:</strong> Look for unexpected network requests or URL processing</li>
                                    {% endif %}
                                {% endif %}
                                
                                <!-- General guidance -->
                                <li><strong>General:</strong> Examine the vulnerability metadata above and check the target endpoint for the specific security issue</li>
                                
                                <!-- Confidence-based guidance -->
                                {% if vulnerability.details and vulnerability.details.confidence %}
                                    {% if vulnerability.details.confidence == 'High' %}
                                    <li><strong>High Confidence:</strong> This vulnerability is likely confirmed - focus on immediate remediation</li>
                                    {% elif vulnerability.details.confidence == 'Medium' %}
                                    <li><strong>Medium Confidence:</strong> Verify this finding manually before remediation</li>
                {% else %}
                                    <li><strong>Low Confidence:</strong> This may be a false positive - investigate thoroughly</li>
                                    {% endif %}
                {% endif %}
            </ul>
                        </div>
                    </div>
            {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
        
        <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools"></i> Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        {% if not vulnerability.false_positive %}
                            <button class="btn btn-outline-warning" onclick="markFalsePositive()">
                                <i class="fas fa-times"></i> Mark as False Positive
                            </button>
            {% endif %}
                        {% if not vulnerability.remediated %}
                            <button class="btn btn-outline-success" onclick="markRemediated()">
                                <i class="fas fa-check"></i> Mark as Remediated
                            </button>
            {% endif %}
                        {% if vulnerability.scan and vulnerability.scan.endpoint %}
                            <button class="btn btn-outline-primary" onclick="runRescan()">
                                <i class="fas fa-redo"></i> Re-scan Endpoint
                            </button>
            {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function markFalsePositive() {
    if (confirm('Mark this vulnerability as a false positive?')) {
        fetch(`/api/mark-vulnerability-false-positive/{{ vulnerability.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}

function markRemediated() {
    if (confirm('Mark this vulnerability as remediated?')) {
        fetch(`/api/mark-vulnerability-remediated/{{ vulnerability.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}

function runRescan() {
    if (confirm('Run a new security scan on the related endpoint?')) {
        // Add rescan logic here
        alert('Re-scan functionality coming soon!');
    }
}
</script>
{% endblock %}
