{% extends "dashboard/base.html" %}

{% block title %}Real-Time Monitoring{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-satellite-dish"></i> Real-Time API Monitoring
        </h1>
        <div>
            <button class="btn btn-success btn-sm" onclick="startMonitoring()">
                <i class="fas fa-play"></i> Start Monitoring
            </button>
            <button class="btn btn-danger btn-sm" onclick="stopMonitoring()">
                <i class="fas fa-stop"></i> Stop Monitoring
            </button>
        </div>
    </div>

    <!-- Real-Time Status Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Monitoring Status
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="monitoringStatus">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-satellite-dish fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Services Monitored
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="servicesMonitored">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-server fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Check Interval
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="checkInterval">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Last Check
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="lastCheck">
                                Loading...
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cog"></i> Monitoring Configuration
                    </h6>
                </div>
                <div class="card-body">
                    <form id="monitoringConfigForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="checkInterval" class="form-label">Check Interval</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="checkIntervalInput" name="check_interval" min="10" max="86400" value="300">
                                    <select class="form-select" id="intervalUnit" name="interval_unit" onchange="updateIntervalValue()">
                                        <option value="seconds">Seconds</option>
                                        <option value="minutes" selected>Minutes</option>
                                        <option value="hours">Hours</option>
                                    </select>
                                </div>
                                <small class="form-text text-muted">How often to check for API changes (10 seconds to 24 hours)</small>
                            </div>
                            <div class="col-md-3">
                                <label for="changeThreshold" class="form-label">Change Threshold (%)</label>
                                <input type="number" class="form-control" id="changeThreshold" name="change_threshold" min="1" max="50" step="0.1" value="10">
                                <small class="form-text text-muted">Minimum change percentage to trigger scan</small>
                            </div>
                            <div class="col-md-3">
                                <label for="scanDepth" class="form-label">Scan Depth</label>
                                <select class="form-select" id="scanDepth" name="scan_depth">
                                    <option value="quick">Quick</option>
                                    <option value="standard">Standard</option>
                                    <option value="comprehensive" selected>Comprehensive</option>
                                </select>
                                <small class="form-text text-muted">Depth of security scans</small>
                            </div>
                            <div class="col-md-3">
                                <label for="autoScanEnabled" class="form-label">Auto-Scanning</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoScanEnabled" name="auto_scan_enabled" checked>
                                    <label class="form-check-label" for="autoScanEnabled">
                                        Enable automatic scanning
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">Security Tools</label>
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="toolZap" name="scan_tools" value="zap" checked>
                                            <label class="form-check-label" for="toolZap">OWASP ZAP</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="toolNuclei" name="scan_tools" value="nuclei" checked>
                                            <label class="form-check-label" for="toolNuclei">Nuclei</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="toolSqlmap" name="scan_tools" value="sqlmap" checked>
                                            <label class="form-check-label" for="toolSqlmap">SQLMap</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="toolSSRFMap" name="scan_tools" value="ssrfmap" checked>
                                            <label class="form-check-label" for="toolSSRFMap">SSRFMap</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Configuration
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadConfiguration()">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Baseline Management Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-database"></i> Baseline Management
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Baseline snapshots are used to detect API changes. Only changed endpoints are scanned automatically.
                                <strong>Establish a baseline after initial service discovery, then enable monitoring.</strong>
                            </p>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>How it works:</strong> First run creates a baseline without scanning. 
                                Subsequent runs detect changes and scan only the specific endpoints that changed.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success btn-lg" onclick="establishBaseline()">
                                    <i class="fas fa-database me-2"></i>
                                    Establish Baseline
                                </button>
                                <button type="button" class="btn btn-warning" onclick="resetBaseline()">
                                    <i class="fas fa-undo me-2"></i>
                                    Reset Baseline
                                </button>
                                <button type="button" class="btn btn-info" onclick="checkBaselineStatus()">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Check Status
                                </button>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="enableScanningBtn" onclick="enableAutoScanning()" style="display: none;">
                                    <i class="fas fa-play me-2"></i>
                                    Enable Auto-Scanning
                                </button>
                                <button type="button" class="btn btn-danger" id="disableScanningBtn" onclick="disableAutoScanning()" style="display: none;">
                                    <i class="fas fa-stop me-2"></i>
                                    Disable Auto-Scanning
                                </button>
                            </div>
                            
                            <div class="mt-3">
                                <div class="alert alert-info" id="scanningStatus">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Status:</strong> <span id="scanningStatusText">Checking...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Changes Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> Recent API Changes
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recentChangesTable">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading recent changes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-Scan Logs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list-alt"></i> Auto-Scan Activity Log
                    </h6>
                </div>
                <div class="card-body">
                    <div id="autoScanLogs">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading auto-scan logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let monitoringStatus = null;
let configForm = null;

document.addEventListener('DOMContentLoaded', function() {
    configForm = document.getElementById('monitoringConfigForm');
    loadMonitoringStatus();
    loadConfiguration();
    loadRecentChanges();
    loadAutoScanLogs();
    
    // Set up form submission
    configForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveConfiguration();
    });
    
    // Auto-refresh every 30 seconds
    setInterval(loadMonitoringStatus, 30000);
});

function loadMonitoringStatus() {
    fetch('/api/realtime-monitoring/status')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received monitoring status data:', data);
            if (data.success) {
                monitoringStatus = data.status;
                updateStatusDisplay();
                
                // Also update baseline status if available
                if (data.baseline_status) {
                    console.log('Baseline status data:', data.baseline_status);
                    displayBaselineStatus(data.baseline_status);
                } else {
                    console.log('No baseline status data received');
                    // If no baseline status, show default message
                    const statusText = document.getElementById('scanningStatusText');
                    const statusDiv = document.getElementById('scanningStatus');
                    if (statusText && statusDiv) {
                        statusText.textContent = 'No baseline established yet';
                        statusDiv.className = 'alert alert-info';
                    }
                }
            } else {
                showNotification('Failed to load monitoring status: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading monitoring status:', error);
            showNotification('Error loading monitoring status: ' + error.message, 'danger');
        });
}

function updateStatusDisplay() {
    if (!monitoringStatus) return;
    
    // Update status cards
    document.getElementById('monitoringStatus').textContent = 
        monitoringStatus.running ? 'Active' : 'Inactive';
    document.getElementById('servicesMonitored').textContent = 
        monitoringStatus.services_monitored || 0;
    // Format check interval for display
    const intervalSeconds = monitoringStatus.check_interval || 300;
    let intervalDisplay;
    if (intervalSeconds >= 3600) {
        intervalDisplay = Math.round(intervalSeconds / 3600) + 'h';
    } else if (intervalSeconds >= 60) {
        intervalDisplay = Math.round(intervalSeconds / 60) + 'm';
    } else {
        intervalDisplay = intervalSeconds + 's';
    }
    document.getElementById('checkInterval').textContent = intervalDisplay;
    
    const lastCheck = monitoringStatus.last_check;
    if (lastCheck) {
        const date = new Date(lastCheck);
        document.getElementById('lastCheck').textContent = 
            date.toLocaleString();
    } else {
        document.getElementById('lastCheck').textContent = 'Never';
    }
}

function loadConfiguration() {
    fetch('/api/realtime-monitoring/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.status;
                
                // Update form fields
                const intervalSeconds = config.check_interval || 1800; // Default to 30 minutes
                
                // Set appropriate unit based on interval value and show user-friendly values
                const unitSelect = document.getElementById('intervalUnit');
                if (intervalSeconds >= 3600) {
                    unitSelect.value = 'hours';
                    document.getElementById('checkIntervalInput').value = Math.round(intervalSeconds / 3600);
                } else if (intervalSeconds >= 60) {
                    unitSelect.value = 'minutes';
                    document.getElementById('checkIntervalInput').value = Math.round(intervalSeconds / 60);
                } else {
                    unitSelect.value = 'seconds';
                    document.getElementById('checkIntervalInput').value = intervalSeconds;
                }
                
                document.getElementById('changeThreshold').value = (config.change_threshold || 0.1) * 100;
                document.getElementById('scanDepth').value = config.scan_depth || 'comprehensive';
                document.getElementById('autoScanEnabled').checked = config.auto_scan_enabled !== false;
                
                // Update tool checkboxes
                const tools = config.scan_tools || [];
                document.getElementById('toolZap').checked = tools.includes('zap');
                document.getElementById('toolNuclei').checked = tools.includes('nuclei');
                document.getElementById('toolSqlmap').checked = tools.includes('sqlmap');
                document.getElementById('toolSSRFMap').checked = tools.includes('ssrfmap');
                
            } else {
                showNotification('Failed to load configuration: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading configuration:', error);
            showNotification('Error loading configuration', 'danger');
        });
}

function updateIntervalValue() {
    const intervalInput = document.getElementById('checkIntervalInput');
    const unitSelect = document.getElementById('intervalUnit');
    const currentValue = parseInt(intervalInput.value) || 30;
    const unit = unitSelect.value;
    
    // Don't update the input value - let the user see their original input
    // The conversion to seconds will happen in saveConfiguration()
}

function saveConfiguration() {
    const formData = new FormData(configForm);
    
    // Convert interval to seconds based on selected unit
    const intervalValue = parseInt(formData.get('check_interval')) || 30;
    const unit = document.getElementById('intervalUnit').value;
    let intervalSeconds;
    
    switch(unit) {
        case 'minutes':
            intervalSeconds = intervalValue * 60;
            break;
        case 'hours':
            intervalSeconds = intervalValue * 3600;
            break;
        default: // seconds
            intervalSeconds = intervalValue;
    }
    
    const config = {
        check_interval: intervalSeconds,
        change_threshold: parseFloat(formData.get('change_threshold')) / 100,
        scan_depth: formData.get('scan_depth'),
        auto_scan_enabled: formData.get('auto_scan_enabled') === 'on',
        scan_tools: []
    };
    
    // Get selected tools
    if (formData.get('scan_tools')) {
        config.scan_tools = formData.getAll('scan_tools');
    }
    
    fetch('/api/realtime-monitoring/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Configuration saved successfully!', 'success');
            loadMonitoringStatus();
        } else {
            showNotification('Failed to save configuration: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showNotification('Error saving configuration', 'danger');
    });
}

function loadRecentChanges() {
    fetch('/api/realtime-monitoring/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const changes = data.recent_changes || [];
                displayRecentChanges(changes);
            } else {
                document.getElementById('recentChangesTable').innerHTML = 
                    '<div class="alert alert-danger">Failed to load recent changes</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recent changes:', error);
            document.getElementById('recentChangesTable').innerHTML = 
                '<div class="alert alert-danger">Error loading recent changes</div>';
        });
}

function displayRecentChanges(changes) {
    const container = document.getElementById('recentChangesTable');
    
    if (changes.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No recent API changes detected</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += '<thead><tr><th>Timestamp</th><th>Service</th><th>Change Type</th><th>Details</th><th>Severity</th></tr></thead><tbody>';
    
    changes.forEach(change => {
        const timestamp = new Date(change.timestamp).toLocaleString();
        const severityClass = change.severity === 'high' ? 'danger' : 
                             change.severity === 'medium' ? 'warning' : 'info';
        
        // Get service name or fallback to service ID
        const serviceName = change.service_name || change.service_id || 'Unknown Service';
        
        // Get affected endpoints count
        const endpointCount = change.affected_endpoints ? change.affected_endpoints.length : 0;
        
        html += `<tr class="clickable-row" onclick="showChangeDetails('${change.service_id}', '${change.change_type}', '${change.timestamp}')" style="cursor: pointer;">
            <td>${timestamp}</td>
            <td>${serviceName}</td>
            <td>${change.change_type || 'Unknown'}</td>
            <td>${change.details || 'N/A'} ${endpointCount > 0 ? `(${endpointCount} endpoints)` : ''}</td>
            <td><span class="badge bg-${severityClass}">${change.severity || 'Unknown'}</span></td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function loadAutoScanLogs() {
    fetch('/api/realtime-monitoring/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const scanActivity = data.scan_activity || [];
                displayAutoScanLogs(scanActivity);
            } else {
                document.getElementById('autoScanLogs').innerHTML = 
                    '<div class="alert alert-danger">Failed to load auto-scan logs</div>';
            }
        })
        .catch(error => {
            console.error('Error loading auto-scan logs:', error);
            document.getElementById('autoScanLogs').innerHTML = 
                '<div class="alert alert-danger">Error loading auto-scan logs</div>';
        });
}

function displayAutoScanLogs(scanActivity) {
    const container = document.getElementById('autoScanLogs');
    
    if (scanActivity.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No auto-scan activity in the last 24 hours</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += '<thead><tr><th>Timestamp</th><th>Service</th><th>Endpoint</th><th>Status</th><th>Duration</th><th>Tools</th></tr></thead><tbody>';
    
    scanActivity.forEach(scan => {
        const timestamp = new Date(scan.timestamp).toLocaleString();
        const statusClass = scan.status === 'completed' ? 'success' : 
                           scan.status === 'failed' ? 'danger' : 
                           scan.status === 'running' ? 'warning' : 'secondary';
        
        const duration = scan.duration ? `${scan.duration}s` : 'N/A';
        const tools = scan.tools_used ? scan.tools_used.join(', ') : 'Unknown';
        
        html += `<tr class="clickable-row" onclick="showScanDetails('${scan.scan_id || scan.timestamp}')" style="cursor: pointer;">
            <td>${timestamp}</td>
            <td>${scan.service_name || 'Unknown'}</td>
            <td>${scan.endpoint_method} ${scan.endpoint_path}</td>
            <td><span class="badge bg-${statusClass}">${scan.status}</span></td>
            <td>${duration}</td>
            <td>${tools}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function startMonitoring() {
    showNotification('Starting real-time monitoring...', 'info');
    
    fetch('/api/realtime-monitoring/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Real-time monitoring started successfully!', 'success');
            // Refresh status after a short delay
            setTimeout(() => {
                loadMonitoringStatus();
            }, 1000);
        } else {
            throw new Error(data.message || 'Failed to start monitoring');
        }
    })
    .catch(error => {
        console.error('Error starting monitoring:', error);
        showNotification('Error starting monitoring: ' + error.message, 'danger');
    });
}

function stopMonitoring() {
    showNotification('Stopping real-time monitoring...', 'info');
    
    fetch('/api/realtime-monitoring/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Real-time monitoring stopped successfully!', 'warning');
            // Refresh status after a short delay
            setTimeout(() => {
                loadMonitoringStatus();
            }, 1000);
        } else {
            throw new Error(data.message || 'Failed to stop monitoring');
        }
    })
    .catch(error => {
        console.error('Error stopping monitoring:', error);
        showNotification('Error stopping monitoring: ' + error.message, 'danger');
    });
}

function establishBaseline() {
    if (!confirm('Are you sure you want to establish a new baseline? This will clear any existing baseline and create a new snapshot of current API state.')) {
        return;
    }
    
    showNotification('Establishing baseline snapshot...', 'info');
    
    fetch('/api/realtime-monitoring/establish-baseline', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Baseline established successfully! No scanning will occur until changes are detected.', 'success');
            // Refresh status after a short delay
            setTimeout(() => {
                loadMonitoringStatus();
            }, 1000);
        } else {
            throw new Error(data.message || 'Failed to establish baseline');
        }
    })
    .catch(error => {
        console.error('Error establishing baseline:', error);
        showNotification('Error establishing baseline: ' + error.message, 'danger');
    });
}

function resetBaseline() {
    if (!confirm('Are you sure you want to reset the baseline? This will force the system to re-establish a new baseline on the next check.')) {
        return;
    }
    
    showNotification('Resetting baseline...', 'warning');
    
    fetch('/api/realtime-monitoring/reset-baseline', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Baseline reset successfully! Next check will establish a new baseline.', 'success');
            // Refresh status after a short delay
            setTimeout(() => {
                loadMonitoringStatus();
            }, 1000);
        } else {
            throw new Error(data.message || 'Failed to reset baseline');
        }
    })
    .catch(error => {
        console.error('Error resetting baseline:', error);
        showNotification('Error resetting baseline: ' + error.message, 'danger');
    });
}

function checkBaselineStatus() {
    showNotification('Checking baseline status...', 'info');
    
    fetch('/api/realtime-monitoring/status')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const baselineStatus = data.baseline_status || {};
                displayBaselineStatus(baselineStatus);
                showNotification('Baseline status check completed.', 'success');
            } else {
                showNotification('Failed to check baseline status: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error checking baseline status:', error);
            showNotification('Error checking baseline status: ' + error.message, 'danger');
        });
}

function displayBaselineStatus(baselineStatus) {
    console.log('displayBaselineStatus called with:', baselineStatus);
    
    // Debug: List all elements with 'scanning' in their ID
    const allElements = document.querySelectorAll('[id*="scanning"]');
    console.log('All elements with "scanning" in ID:', allElements);
    
    // Try to find elements with retry mechanism
    let statusText = document.getElementById('scanningStatusText');
    let statusDiv = document.getElementById('scanningStatus');
    
    console.log('Initial element search:', { statusText, statusDiv });
    
    // If elements not found, wait a bit and try again
    if (!statusText || !statusDiv) {
        console.log('Elements not found, retrying in 200ms...');
        setTimeout(() => {
            statusText = document.getElementById('scanningStatusText');
            statusDiv = document.getElementById('scanningStatus');
            console.log('Retry - Found elements:', { statusText, statusDiv });
            
            if (statusText && statusDiv) {
                updateBaselineStatusDisplay(baselineStatus, statusText, statusDiv);
            } else {
                console.error('Required DOM elements still not found after retry');
                // Try alternative approach - create elements if they don't exist
                createBaselineStatusDisplay(baselineStatus);
            }
        }, 200);
        return;
    }
    
    updateBaselineStatusDisplay(baselineStatus, statusText, statusDiv);
}

function createBaselineStatusDisplay(baselineStatus) {
    console.log('Creating baseline status display elements...');
    
    // Find the baseline management section by looking for the header text
    const headers = document.querySelectorAll('.card-header h6');
    let baselineSection = null;
    
    for (let header of headers) {
        if (header.textContent.includes('Baseline Management')) {
            baselineSection = header.closest('.card');
            break;
        }
    }
    
    // Fallback: look for any card with baseline-related content
    if (!baselineSection) {
        baselineSection = document.querySelector('.card-body') || document.querySelector('.card');
    }
    
    if (baselineSection) {
        console.log('Found baseline section:', baselineSection);
        
        // Create the status display elements
        const statusDiv = document.createElement('div');
        statusDiv.className = 'alert alert-info mt-3';
        statusDiv.id = 'scanningStatus';
        
        const statusText = document.createElement('span');
        statusText.id = 'scanningStatusText';
        
        statusDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Status:</strong> ';
        statusDiv.appendChild(statusText);
        
        // Insert at the end of the card body
        const cardBody = baselineSection.querySelector('.card-body') || baselineSection;
        cardBody.appendChild(statusDiv);
        
        console.log('Created baseline status display elements');
        
        // Now update the display
        updateBaselineStatusDisplay(baselineStatus, statusText, statusDiv);
    } else {
        console.error('Could not find baseline management section to create status display');
    }
}

function updateBaselineStatusDisplay(baselineStatus, statusText, statusDiv) {
    
    if (baselineStatus.baseline_established) {
        const servicesCount = baselineStatus.services_with_baseline || 0;
        const lastUpdate = baselineStatus.last_baseline_update;
        
        let statusMessage = `Baseline established for ${servicesCount} service(s)`;
        if (lastUpdate) {
            const updateDate = new Date(lastUpdate);
            statusMessage += ` (Last updated: ${updateDate.toLocaleString()})`;
        }
        
        if (baselineStatus.auto_scan_enabled) {
            statusMessage += ' - Auto-scanning ENABLED';
            statusDiv.className = 'alert alert-success';
        } else {
            statusMessage += ' - Auto-scanning DISABLED';
            statusDiv.className = 'alert alert-warning';
        }
        
        statusText.textContent = statusMessage;
        
        // Update button visibility
        const enableBtn = document.getElementById('enableScanningBtn');
        const disableBtn = document.getElementById('disableScanningBtn');
        
        if (enableBtn && disableBtn) {
            if (baselineStatus.auto_scan_enabled) {
                enableBtn.style.display = 'none';
                disableBtn.style.display = 'block';
            } else {
                enableBtn.style.display = 'block';
                disableBtn.style.display = 'none';
            }
        }
    } else {
        statusText.textContent = 'No baseline established - Click "Establish Baseline" to create one';
        statusDiv.className = 'alert alert-info';
        
        // Hide both buttons when no baseline
        const enableBtn = document.getElementById('enableScanningBtn');
        const disableBtn = document.getElementById('disableScanningBtn');
        if (enableBtn) enableBtn.style.display = 'none';
        if (disableBtn) disableBtn.style.display = 'none';
    }
}

function enableAutoScanning() {
    if (!confirm('Are you sure you want to enable auto-scanning? This will start scanning changed endpoints automatically.')) {
        return;
    }
    
    showNotification('Enabling auto-scanning...', 'info');
    
    fetch('/api/realtime-monitoring/enable-scanning', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Auto-scanning enabled successfully!', 'success');
            updateScanningStatus(true);
        } else {
            throw new Error(data.message || 'Failed to enable auto-scanning');
        }
    })
    .catch(error => {
        console.error('Error enabling auto-scanning:', error);
        showNotification('Error enabling auto-scanning: ' + error.message, 'danger');
    });
}

function disableAutoScanning() {
    if (!confirm('Are you sure you want to disable auto-scanning? This will stop all automatic scanning.')) {
        return;
    }
    
    showNotification('Disabling auto-scanning...', 'warning');
    
    fetch('/api/realtime-monitoring/disable-scanning', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Auto-scanning disabled successfully!', 'success');
            updateScanningStatus(false);
        } else {
            throw new Error(data.message || 'Failed to disable auto-scanning');
        }
    })
    .catch(error => {
        console.error('Error disabling auto-scanning:', error);
        showNotification('Error disabling auto-scanning: ' + error.message, 'danger');
    });
}

function updateScanningStatus(enabled) {
    const enableBtn = document.getElementById('enableScanningBtn');
    const disableBtn = document.getElementById('disableScanningBtn');
    const statusText = document.getElementById('scanningStatusText');
    const statusDiv = document.getElementById('scanningStatus');
    
    if (enabled) {
        enableBtn.style.display = 'none';
        disableBtn.style.display = 'block';
        statusText.textContent = 'Auto-scanning is ENABLED - scanning changed endpoints';
        statusDiv.className = 'alert alert-success';
    } else {
        enableBtn.style.display = 'block';
        disableBtn.style.display = 'none';
        statusText.textContent = 'Auto-scanning is DISABLED - no scans will be triggered';
        statusDiv.className = 'alert alert-warning';
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Modal functions for detailed views
function showChangeDetails(serviceId, changeType, timestamp) {
    // Create modal content based on change type
    const modalContent = `
        <div class="modal fade" id="changeDetailsModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-info-circle"></i> Change Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-server"></i> Service Information</h6>
                                <p><strong>Service ID:</strong> ${serviceId}</p>
                                <p><strong>Change Type:</strong> ${changeType}</p>
                                <p><strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-line"></i> Impact Assessment</h6>
                                <p><strong>Severity:</strong> <span class="badge bg-warning">Medium</span></p>
                                <p><strong>Status:</strong> <span class="badge bg-success">Detected</span></p>
                            </div>
                        </div>
                        <hr>
                        <h6><i class="fas fa-list"></i> Affected Endpoints</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Method</th>
                                        <th>Path</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            Loading endpoint details...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="triggerServiceScan('${serviceId}')">
                            <i class="fas fa-search"></i> Scan Service
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('changeDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Show modal using Bootstrap's native modal
    const modal = new bootstrap.Modal(document.getElementById('changeDetailsModal'));
    modal.show();
    
    // Load endpoint details
    loadChangeEndpointDetails(serviceId, changeType, timestamp);
}

function showScanDetails(scanId) {
    const modalContent = `
        <div class="modal fade" id="scanDetailsModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-search"></i> Scan Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle"></i> Scan Information</h6>
                                <p><strong>Scan ID:</strong> ${scanId}</p>
                                <p><strong>Status:</strong> <span class="badge bg-warning">Running</span></p>
                                <p><strong>Started:</strong> ${new Date().toLocaleString()}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-tools"></i> Tools Used</h6>
                                <p><strong>ZAP:</strong> <span class="badge bg-success">Active</span></p>
                                <p><strong>Nuclei:</strong> <span class="badge bg-success">Active</span></p>
                                <p><strong>SQLMap:</strong> <span class="badge bg-success">Active</span></p>
                            </div>
                        </div>
                        <hr>
                        <h6><i class="fas fa-shield-alt"></i> Security Findings</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Severity</th>
                                        <th>Vulnerability</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            Scan in progress... Results will appear here.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-info" onclick="refreshScanStatus('${scanId}')">
                            <i class="fas fa-sync"></i> Refresh Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('scanDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Show modal using Bootstrap's native modal
    const modal = new bootstrap.Modal(document.getElementById('scanDetailsModal'));
    modal.show();
    
    // Load scan details from API
    loadScanDetails(scanId);
}

function loadScanDetails(scanId) {
    // Load scan details from API
    fetch(`/api/scan-modal/${scanId}`)
        .then(response => response.text())
        .then(html => {
            const modalBody = document.querySelector('#scanDetailsModal .modal-body');
            if (modalBody) {
                modalBody.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading scan details:', error);
            const modalBody = document.querySelector('#scanDetailsModal .modal-body');
            if (modalBody) {
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error loading scan details. Please try again.
                    </div>
                `;
            }
        });
}

function loadChangeEndpointDetails(serviceId, changeType, timestamp) {
    // Load change details from API
    fetch(`/api/change-modal/${serviceId}`)
        .then(response => response.text())
        .then(html => {
            const modalBody = document.querySelector('#changeDetailsModal .modal-body');
            if (modalBody) {
                modalBody.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading change details:', error);
            const modalBody = document.querySelector('#changeDetailsModal .modal-body');
            if (modalBody) {
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error loading change details. Please try again.
                    </div>
                `;
            }
        });
}

function triggerServiceScan(serviceId) {
    // This would trigger a scan for the specific service
    showNotification('Service scan triggered for service: ' + serviceId, 'success');
    const modal = bootstrap.Modal.getInstance(document.getElementById('changeDetailsModal'));
    if (modal) {
        modal.hide();
    }
}

function refreshScanStatus(scanId) {
    // This would refresh the scan status
    showNotification('Scan status refreshed for scan: ' + scanId, 'info');
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Add a small delay to ensure all elements are fully rendered
    setTimeout(function() {
        // Load initial monitoring status and configuration
        loadMonitoringStatus();
        loadConfiguration();
        loadRecentChanges();
        // loadScanActivity(); // Commented out until function is implemented
    }, 500); // Increased delay to ensure DOM is fully ready
});

</script>
{% endblock %}
